@model IEnumerable<TodoItem>

@{
    ViewData["Title"] = "Мои задачи";
}

<div class="container mt-4" style="max-width: 800px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0">Мои задачи</h2>
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createTaskModal">
            <i class="bi bi-plus-lg"></i> Новая задача
        </button>
    </div>

    <div class="mb-4">
        <button onclick="loadTasks('date')" class="btn btn-light btn-sm border text-muted">По дате</button>
        <button onclick="loadTasks('title')" class="btn btn-light btn-sm border text-muted">По названию</button>
    </div>

    <div id="taskListContainer">
        @await Html.PartialAsync("_TaskList", Model)
    </div>
</div>



<div class="modal fade" id="createTaskModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="createTaskModalLabel">
                    <i class="bi bi-pencil-square me-2 text-primary"></i>Новая задача
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createTaskForm">
                @Html.AntiForgeryToken()

                <div class="modal-body py-4">
                    <div class="mb-3">
                        <label class="form-label small text-muted text-uppercase fw-bold">Название задачи</label>
                        <input type="text" name="Title" class="form-control form-control-lg border-2" id="taskTitle" placeholder="Что нужно сделать?" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted text-uppercase fw-bold">Описание</label>
                        <textarea name="Description" class="form-control border-2" id="taskDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary px-4" id="btnSaveTask">Создать задачу</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editTaskModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold" id="editTaskModalLabel">
                    <i class="bi bi-pencil me-2 text-primary"></i>Редактировать задачу
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editTaskForm">
                <input type="hidden" id="editTaskId" name="Id" />

                <div class="modal-body py-4">
                    <div class="mb-3">
                        <label class="form-label small text-muted text-uppercase fw-bold">Название задачи</label>
                        <input type="text" name="Title" class="form-control form-control-lg border-2" id="editTaskTitle" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted text-uppercase fw-bold">Описание</label>
                        <textarea name="Description" class="form-control border-2" id="editTaskDescription" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary px-4">Сохранить изменения</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsTaskModal" tabindex="-1" aria-labelledby="detailsTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="detailsTaskModalLabel">
                    <i class="bi bi-info-circle me-2"></i>Детали задачи
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4">
                <div class="mb-3">
                    <label class="form-label small text-muted text-uppercase fw-bold">Название</label>
                    <div id="detailsTaskTitle" class="p-2 border rounded bg-light fw-bold"></div>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted text-uppercase fw-bold">Описание</label>
                    <div id="detailsTaskDescription" class="p-2 border rounded bg-light" style="min-height: 100px; white-space: pre-wrap;"></div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="form-label small text-muted text-uppercase fw-bold">Статус</label>
                        <div id="detailsTaskStatus" class="small"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $('#createTaskForm').on('submit', function (e) {
            e.preventDefault();

            var formData = {
                Title: $('#taskTitle').val(),
                Description: $('#taskDescription').val()
            };

            $.ajax({
                url: '@Url.Action("Create", "Todo")',
                type: 'POST',
                data: formData,
                headers: {
                    "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (data) {
                    $('#taskListContainer').html(data);

                    // Закрытие модалки
                    var modalEl = document.getElementById('createTaskModal');
                    var modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) {
                        modal.hide();
                    }

                    $('#createTaskForm')[0].reset();
                },
                error: function (xhr) {
                    alert("Ошибка: " + xhr.responseText);
                }
            });
        });

        $(document).on('click', '.details-task-btn', function() {
            var title = $(this).data('title');
            var description = $(this).data('description');
            var is_completed = $(this).data('is_completed');

            $('#detailsTaskTitle').text(title);
            $('#detailsTaskDescription').text(description || "Описание отсутствует");

            const statusEl = $('#detailsTaskStatus');
            if (is_completed) {
                statusEl.html('<span class="badge bg-success">Выполнено</span>');
            } else {
                statusEl.html('<span class="badge bg-warning text-dark">В процессе</span>');
            }

            var modalEl = document.getElementById('detailsTaskModal');
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
        });

        $(document).on('click', '.edit-task-btn', function() {
            var id = $(this).data('id');
            var title = $(this).data('title');
            var description = $(this).data('description');

            $('#editTaskId').val(id);
            $('#editTaskTitle').val(title);
            $('#editTaskDescription').val(description);

            var modalEl = document.getElementById('editTaskModal');
            var modal = new bootstrap.Modal(modalEl);
            modal.show();
        });

        $('#editTaskForm').on('submit', function (e) {
            e.preventDefault();

            var formData = {
                Id: $('#editTaskId').val(),
                Title: $('#editTaskTitle').val(),
                Description: $('#editTaskDescription').val()
            };

            $.ajax({
                url: '@Url.Action("Edit", "Todo")',
                type: 'POST',
                data: formData,
                headers: {
                    "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (data) {
                    $('#taskListContainer').html(data);
                    var modalEl = document.getElementById('editTaskModal');
                    var modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                },
                error: function (xhr) {
                    alert("Ошибка при сохранении изменений");
                }
            });
        });

        function loadTasks(sortOrder) {
            $('#taskListContainer').css('opacity', '0.5');
            $.ajax({
                url: '@Url.Action("GetTasksPartial", "Todo")',
                type: 'GET',
                data: { sortOrder: sortOrder },
                success: function (data) {
                    $('#taskListContainer').html(data);
                    $('#taskListContainer').css('opacity', '1');
                }
            });
        }

        function toggleTask(taskId) {
             $('#taskListContainer').css('opacity', '0.5');

             $.ajax({
                 url: '@Url.Action("ToggleStatus", "Todo")',
                 type: 'POST',
                 data: { id: taskId },
                 headers: {
                     "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                 },
                 success: function (data) {
                     $('#taskListContainer').html(data);
                     $('#taskListContainer').css('opacity', '1');
                 },
                 error: function (xhr) {
                     $('#taskListContainer').css('opacity', '1');
                     alert("Ошибка смены статуса: " + xhr.status);
                 }
             });
         }

         function deleteTask(taskId) {
             $('#taskListContainer').css('opacity', '0.5');

             $.ajax({
                 url: '@Url.Action("Delete", "Todo")',
                 type: 'DELETE',
                 data: {todoItemId: taskId },
                 headers: {
                     "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val()
                 },
                 success: function (data) {
                     $('#taskListContainer').html(data);
                     $('#taskListContainer').css('opacity', '1');
                 },
                 error: function(xhr) {
                     $('#taskListContainer').css('opacity', '1');
                     alert("Ошибка смены статуса: " + xhr.status);
                 }
             });
         }
    </script>
}